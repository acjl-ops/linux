From: Sebastian Andrzej Siewior <bigeasy@linutronix.de>
Date: Thu, 30 Nov 2023 16:43:01 +0100
Subject: [PATCH] printk/nbcon: Remove the msleep() from
 nbcon_kthread_should_wakeup().
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

The msleep() in nbcon_kthread_should_wakeup() is harmfull as it destroy
the task state. This in turn leads to other problems such that the
printing threads can never rest.

It seems usefull during boot if the console is used by another thread
and instead of spinning it takes a small break instead of spinning.
However this is "brief" and if the printing thread is using the console
and the tty user is "blocked" then it is spinning soâ€¦

Remove the msleep() from nbcon_kthread_should_wakeup().

Signed-off-by: Sebastian Andrzej Siewior <bigeasy@linutronix.de>
---
 kernel/printk/nbcon.c |    7 -------
 1 file changed, 7 deletions(-)

--- a/kernel/printk/nbcon.c
+++ b/kernel/printk/nbcon.c
@@ -1032,13 +1032,6 @@ static bool nbcon_kthread_should_wakeup(
 
 		nbcon_state_read(con, &cur);
 
-		/*
-		 * Some other CPU is using the console. Patiently poll
-		 * to see if it becomes available. This is more efficient
-		 * than having every release trigger an irq_work to wake
-		 * the kthread.
-		 */
-		msleep(1);
 	} while (cur.prio != NBCON_PRIO_NONE);
 
 	/* Bring the sequence in @ctxt up to date */
